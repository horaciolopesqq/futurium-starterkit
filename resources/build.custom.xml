<?xml version="1.0" encoding="UTF-8" ?>
<project name="My subsite" default="help">

    <target name="build-custom"
        description="You can use this target to perform custom build steps for your subsite. This target is part of both build-dev and build-dist.">
        <echo message="Running custom build" />
    </target>

    <target name="build-dev"
        description="Build a local development version of the subsite."
        depends="
            install-build-dependencies,
            delete-dev,
            make-dev,
            link-dev-resources,
            install-dev-dependencies,
            link-behat,
            setup-behat,
            update-htaccess,
            setup-files-directory,
            setup-php-codesniffer,
            download-development-modules,
            build-futurium"
    />

    <target name="build"
        description="Build a local development version of the subsite."
        depends="
            install-build-dependencies,
            delete-dev,
            link-behat,
            setup-behat,
            update-htaccess,
            setup-files-directory,
            setup-php-codesniffer,
            build-futurium"
    />

    <target name="build-futurium"
        description="Get modules and Futurium Profile.">

        <if>
            <not><available file="${futurium.profile.dir}" type="dir" property="dir.Exists" /></not>
            <then>
                <!-- Set revision to HEAD if not already defined -->
                <property name="repo.revision" value="HEAD" override="false"/>

                <echo>Cloning ${futurium.profile.repository} ${futurium.profile.branch} into ${futurium.profile.dir}</echo>

                <gitclone
                        gitPath="git"
                        repository="${futurium.profile.repository}"
                        targetPath="${futurium.profile.dir}" />
                <gitpull
                        repository="${futurium.profile.dir}"
                        source="origin" refspec="${futurium.profile.branch}"
                        strategy="recursive" keep="true"
                        force="true" quiet="true" norebase="true" />
            </then>
            <else>
                <echo msg="Checking if remote branch exists..." />
                <exec command="git ls-remote --heads ${futurium.profile.repository} ${futurium.profile.branch}" outputProperty="remote.Exists" />
                <if>
                    <or>
                        <not><isset property="remote.Exists" /></not>
                        <and>
                            <isset property="remote.Exists" />
                            <equals arg1="${remote.Exists}" arg2="" />
                        </and>
                    </or>
                    <then>
                        <echo msg="Pulling changes from the Futurium Profile repository." />
                        <exec command="git pull" dir="${futurium.profile.dir}" passthru="true" checkreturn="true" />
                    </then>
                    <else>
                        <echo msg="The current branch doesn't exist on remote, skipping." level="warning" />
                    </else>
                </if>
            </else>
        </if>

        <echo msg="Make the profile." />
        <phingcall target="drush-make-no-core">
            <property name="drush.make.target.file" value="lib/profiles/futurium/futurium.make" />
            <property name="drush.make.root" value="${phing.project.tmp.dir}/futurium" />
        </phingcall>

        <exec command='cp -R ${phing.project.tmp.dir}/futurium/sites/all/* ${futurium.profile.dir}'
              passthru="true"
              checkreturn="true" />

        <echo msg="Copying profile from ${futurium.profile.dir} into platform." />
        <if>
            <not><available file="./platform/profiles" type="dir" property="dir.Exists" /></not>
            <then>
                <exec command="mkdir -p ./platform/profiles" passthru="true" checkreturn="true" />
            </then>
        </if>
        <exec command='ln -s ${project.basedir}/${futurium.profile.dir} ${project.basedir}/platform/profiles/futurium '
            passthru="true"
            checkreturn="true" />

       <echo msg="Clearing temp folder." />
       <exec command="rm -rf ${phing.project.tmp.dir}/futurium" />
    </target>

    <!-- Download the platform. -->
    <target name="download-platform">
        <drush
            command="dl"
            assume="yes"
            bin="${drush.bin}"
            pipe="yes"
            verbose="${drush.verbose}">
            <param>drupal-${drupal.version}</param>
            <option name="destination">${project.basedir}</option>
            <option name="drupal-project-rename">${drupal.installation_path}</option>
        </drush>
    </target>

    <!-- Rebuild node access. -->
    <target name="rebuild-node-access">
        <echo msg="Rebuilding node_access table." />
        <drush
            command="php-eval"
            assume="yes"
            root="${platform.build.dir}"
            bin="${drush.bin}"
            verbose="${drush.verbose}">
            <param>"node_access_rebuild()"</param>
        </drush>

        <echo msg="Force reverting all features." />
        <drush
            command="fra"
            assume="yes"
            root="${platform.build.dir}"
            bin="${drush.bin}"
            verbose="${drush.verbose}">
            <option name="force"></option>
        </drush>
    </target>

    <!-- Make the development version of the subsite. -->
    <target name="make-dev" depends="download-platform">
        <if>
            <available file="${subsite.make}" type="file" />
                <then>
                    <echo msg="Make the subsite." />
                    <phingcall target="drush-make-no-core">
                        <property name="drush.make.target.file" value="${subsite.make}" />
                        <property name="drush.make.root" value="${platform.build.dir}" />
                    </phingcall>
                </then>
            <else>
                <echo msg="No make file found. Skipping..." />
            </else>
        </if>
    </target>

</project>
